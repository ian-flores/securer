# securer

> \[!WARNING\] **This package is fully experimental.** The API is
> unstable and may change without notice. Use at your own risk — not
> recommended for production workloads.

**Let LLMs write R code that calls your functions — safely.**

When an LLM generates R code, you need two things: a way for that code
to call back into your application (tool calls), and confidence that the
code can’t do anything dangerous (sandboxing). securer provides both.

``` r
library(securer)

# Your functions become tools the LLM's code can call
tools <- list(
  securer_tool("query_db", "Query a database table",
    fn = function(table, limit) head(get(table, "package:datasets"), limit),
    args = list(table = "character", limit = "numeric"))
)

# LLM-generated code runs sandboxed — tool calls pause, execute on your side, resume
result <- execute_r('
  data <- query_db("mtcars", 5)
  mean(data$mpg)
', tools = tools, sandbox = TRUE)
```

The child R process is sandboxed at the OS level. Tool functions execute
on the host side, outside the sandbox, with full access to your
resources. The LLM’s code never touches your filesystem, network, or
data directly.

## Installation

``` r
# install.packages("pak")
pak::pak("ian-flores/securer")
```

## Why securer?

| Problem                                    | How securer solves it                                                      |
|--------------------------------------------|----------------------------------------------------------------------------|
| LLM code could access the filesystem       | OS sandbox blocks writes; reads restricted to R libraries                  |
| LLM code could make network requests       | Network access blocked via namespace isolation (Linux) or Seatbelt (macOS) |
| LLM code needs to call your APIs/databases | Register tool functions that execute on the host side, outside the sandbox |
| LLM code could run forever                 | Execution timeouts with automatic session recovery                         |
| LLM code could consume all memory          | Resource limits (CPU, memory, file size, processes) via ulimit             |
| LLM code has syntax errors                 | Pre-validation catches parse errors before execution                       |

## How It Works

    ┌──────────────────────┐        ┌──────────────────────┐
    │    Parent (host)      │        │  Child (sandboxed R)  │
    │                       │        │                       │
    │  1. Send code ────────┼───────>│  2. eval(code)        │
    │                       │  UDS   │                       │
    │  3. Execute tool  <───┼────────│  Code calls tool()    │
    │     (your function)   │        │  → pauses on socket   │
    │                       │        │                       │
    │  4. Send result ──────┼───────>│  5. Resumes with      │
    │                       │        │     tool result       │
    │                       │        │                       │
    │  6. Receive final <───┼────────│  Returns final value  │
    │     result            │        │                       │
    └──────────────────────┘        └──────────────────────┘

Communication happens over a Unix domain socket. Tool calls are
synchronous: the child blocks while the parent fulfills the request.

## Features

### Persistent Sessions

Reuse a session across multiple executions to avoid startup overhead:

``` r
session <- SecureSession$new(tools = tools, sandbox = TRUE)

session$execute('query_db("iris", 3)')
session$execute('query_db("mtcars", 5)')

session$close()
```

### Session Pooling

Pre-warm multiple sessions for low-latency concurrent execution:

``` r
pool <- SecureSessionPool$new(size = 4, tools = tools, sandbox = TRUE)

result <- pool$execute('query_db("iris", 3)')

pool$close()
```

### Resource Limits

Constrain CPU, memory, and file size regardless of sandbox mode:

``` r
result <- execute_r("1 + 1",
  limits = list(cpu = 10, memory = 256 * 1024 * 1024)
)
```

### Execution Timeouts

Kill long-running code automatically. The session recovers and is
reusable:

``` r
session <- SecureSession$new()
session$execute("Sys.sleep(100)", timeout = 5)
# Error: Execution timed out after 5 seconds
session$execute("1 + 1")  # still works
```

### Code Pre-Validation

Catch syntax errors before sending code to the child process:

``` r
session$execute("if (TRUE {")  # immediate error, no child round-trip
```

### ellmer Integration

Use securer as a code execution tool in
[ellmer](https://ellmer.tidyverse.org/) LLM chats:

``` r
library(ellmer)
chat <- chat_openai()
chat$register_tool(securer_as_ellmer_tool())
chat$chat("Calculate the mean of 1 through 100 using R")
```

### Audit Logging

Write structured JSONL logs of all session events for compliance and
debugging:

``` r
session <- SecureSession$new(audit_log = "session.jsonl")
```

### Verbose Logging

Debug session behavior with human-readable
[`message()`](https://rdrr.io/r/base/message.html) output:

``` r
session <- SecureSession$new(verbose = TRUE)
# [securer] Session started (sandbox=FALSE, pid=1234)
# [securer] Tool call: query_db(table="iris", limit=3)
# [securer] Execution complete (0.5s)
```

## Platform Support

| Platform    | Sandbox                   | Network blocked           | Filesystem restricted     |
|-------------|---------------------------|---------------------------|---------------------------|
| **Linux**   | bubblewrap (`bwrap`)      | Yes (namespace isolation) | Yes (read-only mounts)    |
| **macOS**   | Seatbelt (`sandbox-exec`) | Yes (IP denied)           | Yes (writes to /tmp only) |
| **Windows** | Environment isolation     | No                        | No                        |

Linux and macOS provide full OS-level sandboxing. Windows provides
environment variable isolation only (clean HOME, empty R_LIBS_USER). All
platforms support resource limits and tool call IPC.

## Documentation

- [`vignette("getting-started", package = "securer")`](https://ian-flores.github.io/securer/articles/getting-started.md)
  — full walkthrough
- [pkgdown site](https://ian-flores.github.io/securer/) — API reference

## License

MIT

# Package index

## Core

Primary API for secure code execution

- [`SecureSession`](https://ian-flores.github.io/securer/reference/SecureSession.md)
  : SecureSession
- [`SecureSessionPool`](https://ian-flores.github.io/securer/reference/SecureSessionPool.md)
  : SecureSessionPool
- [`execute_r()`](https://ian-flores.github.io/securer/reference/execute_r.md)
  : Execute R code securely with tool support
- [`securer_tool()`](https://ian-flores.github.io/securer/reference/securer_tool.md)
  : Create a tool definition

## Validation & Logging

Code validation and audit logging

- [`validate_code()`](https://ian-flores.github.io/securer/reference/validate_code.md)
  : Validate R code before execution
- [`format_tool_result()`](https://ian-flores.github.io/securer/reference/format_tool_result.md)
  : Format an R value as a tool result string

## Integrations

LLM framework adapters

- [`securer_as_ellmer_tool()`](https://ian-flores.github.io/securer/reference/securer_as_ellmer_tool.md)
  : Create an ellmer tool for secure R code execution

## Sandbox

OS-level sandboxing backends

- [`build_sandbox_config()`](https://ian-flores.github.io/securer/reference/build_sandbox_config.md)
  : Build sandbox configuration for the current platform
- [`build_sandbox_macos()`](https://ian-flores.github.io/securer/reference/build_sandbox_macos.md)
  : Build macOS sandbox configuration
- [`build_sandbox_linux()`](https://ian-flores.github.io/securer/reference/build_sandbox_linux.md)
  : Build Linux sandbox configuration
- [`build_sandbox_windows()`](https://ian-flores.github.io/securer/reference/build_sandbox_windows.md)
  : Build Windows sandbox configuration
- [`build_sandbox_fallback()`](https://ian-flores.github.io/securer/reference/build_sandbox_fallback.md)
  : Build fallback sandbox configuration (no OS sandbox)
- [`generate_seatbelt_profile()`](https://ian-flores.github.io/securer/reference/generate_seatbelt_profile.md)
  : Generate a macOS Seatbelt profile for the sandboxed R session
- [`generate_bwrap_args()`](https://ian-flores.github.io/securer/reference/generate_bwrap_args.md)
  : Generate bubblewrap CLI arguments for the sandboxed R session

## Resource Limits

Process resource restrictions

- [`validate_limits()`](https://ian-flores.github.io/securer/reference/validate_limits.md)
  : Validate a limits list
- [`generate_ulimit_commands()`](https://ian-flores.github.io/securer/reference/generate_ulimit_commands.md)
  : Generate ulimit shell commands from a limits list
- [`build_limits_only_wrapper()`](https://ian-flores.github.io/securer/reference/build_limits_only_wrapper.md)
  : Build a minimal wrapper script that only applies resource limits

## Internals

Low-level IPC and child runtime

- [`child_runtime_code()`](https://ian-flores.github.io/securer/reference/child_runtime_code.md)
  : Generate the R code to inject into the child process
- [`ipc_create_server()`](https://ian-flores.github.io/securer/reference/ipc_create_server.md)
  : Create a Unix domain socket server
- [`ipc_accept()`](https://ian-flores.github.io/securer/reference/ipc_accept.md)
  : Accept a client connection on a Unix domain socket server
- [`ipc_read_message()`](https://ian-flores.github.io/securer/reference/ipc_read_message.md)
  : Read a message from an IPC connection
- [`ipc_write_message()`](https://ian-flores.github.io/securer/reference/ipc_write_message.md)
  : Write a message to an IPC connection
- [`validate_tools()`](https://ian-flores.github.io/securer/reference/validate_tools.md)
  : Validate a list of tools
- [`generate_tool_wrappers()`](https://ian-flores.github.io/securer/reference/generate_tool_wrappers.md)
  : Generate wrapper code for tools in the child process
- [`generate_type_checks()`](https://ian-flores.github.io/securer/reference/generate_type_checks.md)
  : Generate type validation code for tool arguments
- [`type_check_map`](https://ian-flores.github.io/securer/reference/type_check_map.md)
  : Map of type annotation strings to R type-checking functions

# Articles

### All vignettes

- [Using securer with
  ellmer](https://ian-flores.github.io/securer/articles/ellmer-integration.md):
- [Getting Started with
  securer](https://ian-flores.github.io/securer/articles/getting-started.md):
