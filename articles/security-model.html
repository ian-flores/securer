<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Security Model • securer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Security Model">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">securer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ellmer-integration.html">Using securer with ellmer</a></li>
    <li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with securer</a></li>
    <li><a class="dropdown-item" href="../articles/security-model.html">Security Model</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ian-flores/securer"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Security Model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ian-flores/securer/blob/main/vignettes/security-model.Rmd" class="external-link"><code>vignettes/security-model.Rmd</code></a></small>
      <div class="d-none name"><code>security-model.Rmd</code></div>
    </div>

    
    
<p>This document describes the security architecture and threat model of
the securer package. It is intended for security auditors, deployers
evaluating risk, and contributors working on the sandboxing code.</p>
<div class="section level2">
<h2 id="threat-model">Threat model<a class="anchor" aria-label="anchor" href="#threat-model"></a>
</h2>
<div class="section level3">
<h3 id="attacker">Attacker<a class="anchor" aria-label="anchor" href="#attacker"></a>
</h3>
<p>The attacker is <strong>LLM-generated R code</strong> running inside
the child process. An LLM may produce code that is malicious by intent
(prompt injection) or by accident (hallucinated system calls, unintended
side effects). The code has full access to the R language within the
child process and can attempt arbitrary operations including file I/O,
network access, process execution, and resource exhaustion.</p>
</div>
<div class="section level3">
<h3 id="what-we-are-protecting">What we are protecting<a class="anchor" aria-label="anchor" href="#what-we-are-protecting"></a>
</h3>
<ul>
<li>
<strong>Host filesystem</strong> – prevent reading sensitive files
(SSH keys, credentials, application data) and writing to arbitrary
locations</li>
<li>
<strong>Network</strong> – prevent the child from making HTTP
requests, exfiltrating data, or connecting to internal services</li>
<li>
<strong>Other processes</strong> – prevent the child from signaling,
debugging, or interfering with other processes on the host</li>
<li>
<strong>Host resources</strong> – prevent CPU exhaustion, memory
exhaustion, fork bombs, and disk-filling attacks</li>
</ul>
</div>
<div class="section level3">
<h3 id="trust-boundaries">Trust boundaries<a class="anchor" aria-label="anchor" href="#trust-boundaries"></a>
</h3>
<pre><code>+------------------------------------------+
|  Host / parent process (TRUSTED)         |
|  - Registers tools (fn runs here)        |
|  - Controls session lifecycle            |
|  - Reads/writes IPC socket               |
+------------------+-----------------------+
                   |
            Unix domain socket
         (IPC boundary / trust boundary)
                   |
+------------------+-----------------------+
|  Child R process (UNTRUSTED)             |
|  - Executes LLM-generated code           |
|  - Can only call registered tools via    |
|    .securer_call_tool() over IPC         |
|  - Runs inside OS sandbox + ulimits      |
+------------------------------------------+</code></pre>
<p>The parent process is fully trusted. It registers tool functions,
manages the child process lifecycle, and executes tool calls with full
host privileges.</p>
<p>The child process is untrusted. All code evaluated in the child is
treated as potentially hostile. The IPC channel (Unix domain socket) is
the trust boundary. The child can only affect the host by sending
tool-call requests over this channel, which the parent validates before
executing.</p>
</div>
</div>
<div class="section level2">
<h2 id="defense-layers">Defense layers<a class="anchor" aria-label="anchor" href="#defense-layers"></a>
</h2>
<p>securer uses defense in depth. No single layer is sufficient; they
are designed to be redundant so that a bypass in one layer is caught by
another.</p>
<div class="section level3">
<h3 id="layer-1-os-level-sandbox">Layer 1: OS-level sandbox<a class="anchor" aria-label="anchor" href="#layer-1-os-level-sandbox"></a>
</h3>
<p>The outermost defense. Restricts what the child process can do at the
operating system level.</p>
<div class="section level4">
<h4 id="macos-seatbelt-sandbox-exec">macOS: Seatbelt (<code>sandbox-exec</code>)<a class="anchor" aria-label="anchor" href="#macos-seatbelt-sandbox-exec"></a>
</h4>
<p>The child R process runs inside
<code>sandbox-exec -f profile.sb</code>. The profile is generated
dynamically by <code><a href="../reference/generate_seatbelt_profile.html">generate_seatbelt_profile()</a></code> with a
<strong>deny-default</strong> policy:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The generated profile starts with:</span></span>
<span><span class="co"># (version 1)</span></span>
<span><span class="co"># (deny default)</span></span></code></pre></div>
<p><strong>Allowed operations:</strong></p>
<ul>
<li>
<strong>File reads</strong>: R installation (<code><a href="https://rdrr.io/r/base/Rhome.html" class="external-link">R.home()</a></code>),
R library paths (<code><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">.libPaths()</a></code>), system libraries
(<code>/usr</code>, <code>/Library/Frameworks</code>,
<code>/System/Library</code>, <code>/opt/homebrew</code>), device nodes
(<code>/dev</code>), specific <code>/etc</code> files (localtime, ssl
certs, hosts), temp directories (<code>/tmp</code>,
<code>/private/var/folders/</code>), and the sandbox profile itself</li>
<li>
<strong>File writes</strong>: only to the session-specific socket
directory (<code>/tmp/securer_XXXXX/</code>), R’s per-user temp area
(<code>/private/var/folders/...</code>), and specific device nodes
(<code>/dev/null</code>, <code>/dev/tty</code>,
<code>/dev/random</code>, <code>/dev/urandom</code>)</li>
<li>
<strong>Network</strong>: Unix domain sockets only (local IPC). All
remote IP traffic (TCP/UDP) is explicitly denied</li>
<li>
<strong>Process execution</strong>: R binaries
(<code>R.home()/bin/</code>), <code>/bin/sh</code>,
<code>/bin/bash</code>, and a handful of POSIX utilities needed by R’s
startup script (<code>sed</code>, <code>uname</code>, <code>grep</code>,
<code>dirname</code>, <code>basename</code>, <code>rm</code>). Other
interpreters (python, perl, ruby, node) are blocked</li>
<li>
<strong>System</strong>: Mach IPC, sysctl, signals, IOKit, POSIX IPC
(required by R and macOS internals)</li>
</ul>
<p><strong>Not allowed:</strong></p>
<ul>
<li>Writing to the user’s home directory</li>
<li>Reading <code>~/.ssh</code>, <code>~/.aws</code>,
<code>~/.config</code> (these paths are not under any allowed subpath,
though note that broad <code>/usr</code> reads are allowed)</li>
<li>Outbound HTTP/HTTPS connections</li>
<li>Executing arbitrary binaries</li>
</ul>
<p>The profile is written to a temp file and passed to
<code>sandbox-exec -f</code>. The wrapper script is injected via
<code>callr::r_session_options(arch = "/path/to/wrapper.sh")</code>,
which callr treats as a direct path to the R binary.</p>
</div>
<div class="section level4">
<h4 id="linux-bubblewrap-bwrap">Linux: bubblewrap (<code>bwrap</code>)<a class="anchor" aria-label="anchor" href="#linux-bubblewrap-bwrap"></a>
</h4>
<p>The child runs inside <code>bwrap --unshare-all</code>, which creates
isolated PID, network, user, mount, UTS, and IPC namespaces:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Key bwrap arguments:</span></span>
<span><span class="co"># --unshare-all        isolate all namespaces</span></span>
<span><span class="co"># --die-with-parent    kill child if parent dies</span></span>
<span><span class="co"># --new-session        new session ID (prevents terminal hijacking)</span></span>
<span><span class="co"># --ro-bind /usr /usr  read-only system libraries</span></span>
<span><span class="co"># --ro-bind R.home()   read-only R installation</span></span>
<span><span class="co"># --tmpfs /tmp         clean writable /tmp</span></span>
<span><span class="co"># --bind socket_dir    writable socket directory (overlays /tmp)</span></span>
<span><span class="co"># --proc /proc         minimal proc filesystem</span></span>
<span><span class="co"># --dev /dev           minimal dev nodes</span></span></code></pre></div>
<p><strong>Filesystem</strong>: The root filesystem is not mounted. Only
explicitly listed paths are available. System libraries
(<code>/usr</code>, <code>/lib</code>, <code>/lib64</code>,
<code>/bin</code>, <code>/sbin</code>), config files
(<code>/etc/ld.so.cache</code>, <code>/etc/localtime</code>,
<code>/etc/ssl</code>, <code>/etc/R</code>), and the R installation are
bind-mounted read-only. R library paths outside <code>/usr</code> and
<code><a href="https://rdrr.io/r/base/Rhome.html" class="external-link">R.home()</a></code> are also bind-mounted read-only. <code>/tmp</code>
is a clean <code>tmpfs</code>. The socket directory is bind-mounted
writable on top of <code>/tmp</code>.</p>
<p><strong>Network</strong>: Completely isolated via
<code>--unshare-net</code>. The child has no network interfaces at all
(not even loopback in some configurations).</p>
<p><strong>Process isolation</strong>: Separate PID namespace. The child
sees itself as PID 1. Cannot see or signal host processes.</p>
<p><strong>HOME/TMPDIR</strong>: Set to <code>/tmp</code> inside the
namespace. <code>R_LIBS_USER</code> is set empty.</p>
</div>
<div class="section level4">
<h4 id="windows-environment-isolation-job-objects">Windows: environment isolation + Job Objects<a class="anchor" aria-label="anchor" href="#windows-environment-isolation-job-objects"></a>
</h4>
<p>Windows lacks a userspace sandboxing API equivalent to Seatbelt or
bubblewrap. securer provides two weaker mechanisms:</p>
<p><strong>Environment isolation</strong>: The child gets a sanitized
environment with <code>HOME</code>, <code>TMPDIR</code>,
<code>TMP</code>, and <code>TEMP</code> pointing to a private temp
directory, and <code>R_LIBS_USER</code> set to empty string. This
prevents the child from loading packages from the user’s personal
library or writing to the user’s home via <code>HOME</code>.</p>
<p><strong>Job Objects</strong> (resource limits only): When resource
limits are specified, securer generates a PowerShell script that uses C#
P/Invoke to create a Windows Job Object and assign the child process to
it. Supported limits:</p>
<ul>
<li>
<code>ProcessMemoryLimit</code> (from <code>memory</code>
limit)</li>
<li>
<code>PerProcessUserTimeLimit</code> (from <code>cpu</code> limit,
converted to 100ns units)</li>
<li>
<code>ActiveProcessLimit</code> (from <code>nproc</code> limit)</li>
</ul>
<p>The Job Object also sets
<code>JOB_OBJECT_LIMIT_KILL_ON_JOB_CLOSE</code> so child processes are
terminated when the job handle closes.</p>
<p>Limits that have no Job Object equivalent (<code>fsize</code>,
<code>nofile</code>, <code>stack</code>) emit a warning and are
skipped.</p>
<p><strong>No filesystem or network restrictions are applied on
Windows.</strong> The child process can read and write anywhere the user
account has access, and can make network connections.</p>
</div>
</div>
<div class="section level3">
<h3 id="layer-2-resource-limits">Layer 2: Resource limits<a class="anchor" aria-label="anchor" href="#layer-2-resource-limits"></a>
</h3>
<p>Prevent resource exhaustion attacks. Applied via <code>ulimit</code>
on Unix and Job Objects on Windows.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Default limits (applied automatically when sandbox = TRUE):</span></span>
<span><span class="fu"><a href="../reference/default_limits.html">default_limits</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $cpu     60          # 60 seconds CPU time</span></span>
<span><span class="co">#&gt; $memory  536870912   # 512 MB virtual memory</span></span>
<span><span class="co">#&gt; $fsize   52428800    # 50 MB max file size</span></span>
<span><span class="co">#&gt; $nproc   50          # 50 child processes</span></span>
<span><span class="co">#&gt; $nofile  256         # 256 open file descriptors</span></span></code></pre></div>
<p>The wrapper script sets both soft and hard limits
(<code>ulimit -S -H</code>) before <code>exec</code>-ing R, so the child
cannot raise them:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generated wrapper script (Unix):</span></span>
<span><span class="co"># #!/bin/sh</span></span>
<span><span class="co"># ulimit -S -H -t 60       # CPU seconds</span></span>
<span><span class="co"># ulimit -S -H -v 524288   # virtual memory in KB</span></span>
<span><span class="co"># ulimit -S -H -f 102400   # file size in 512-byte blocks</span></span>
<span><span class="co"># ulimit -S -H -u 50       # max processes</span></span>
<span><span class="co"># ulimit -S -H -n 256      # max open files</span></span>
<span><span class="co"># exec /usr/bin/sandbox-exec -f /tmp/securer_XXX.sb /path/to/R "$@"</span></span></code></pre></div>
<p>Resource limits can be used independently of the sandbox
(<code>sandbox = FALSE, limits = list(cpu = 30)</code>), in which case a
minimal wrapper script applies only the <code>ulimit</code>
commands.</p>
</div>
<div class="section level3">
<h3 id="layer-3-execution-timeouts">Layer 3: Execution timeouts<a class="anchor" aria-label="anchor" href="#layer-3-execution-timeouts"></a>
</h3>
<p>Wall-clock deadline enforced in the parent’s event loop. Unlike
<code>ulimit -t</code> (which measures CPU time), this catches cases
where the child is blocked on I/O or sleeping:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"Sys.sleep(3600)"</span>, timeout <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Execution timed out after 10 seconds</span></span></code></pre></div>
<p>On timeout:</p>
<ol style="list-style-type: decimal">
<li>The child process is killed (<code>$kill()</code>)</li>
<li>The IPC connection is cleaned up</li>
<li>The socket and sandbox temp files are removed</li>
<li>A new session is started automatically so the
<code>SecureSession</code> object remains usable for subsequent
calls</li>
</ol>
</div>
<div class="section level3">
<h3 id="layer-4-ipc-authentication">Layer 4: IPC authentication<a class="anchor" aria-label="anchor" href="#layer-4-ipc-authentication"></a>
</h3>
<p>When the child process connects to the Unix domain socket, it must
present a 32-character random token as its first message. The parent
generates this token at session creation and passes it to the child via
the <code>SECURER_TOKEN</code> environment variable.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parent generates token:</span></span>
<span><span class="va">private</span><span class="op">$</span><span class="va">ipc_token</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">letters</span>, <span class="va">LETTERS</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span>, <span class="fl">32</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  collapse <span class="op">=</span> <span class="st">""</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Child sends token as first message after connecting:</span></span>
<span><span class="co"># processx::conn_write(conn, paste0(Sys.getenv("SECURER_TOKEN"), "\n"))</span></span>
<span></span>
<span><span class="co"># Parent validates:</span></span>
<span><span class="co"># if (!identical(auth_line, private$ipc_token))</span></span>
<span><span class="co">#   stop("IPC authentication failed")</span></span></code></pre></div>
<p>This prevents another process from connecting to the socket and
injecting tool calls. Combined with the 0700 directory permissions on
the socket directory, only the current user can access the socket.</p>
</div>
<div class="section level3">
<h3 id="layer-5-ipc-message-validation">Layer 5: IPC message validation<a class="anchor" aria-label="anchor" href="#layer-5-ipc-message-validation"></a>
</h3>
<p>Every message from the child is validated before processing:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Size limit</strong>: Messages larger than 1 MB
(configurable via <code>private$max_ipc_message_size</code>) are
rejected before JSON parsing. This prevents memory exhaustion via a
single oversized message.</p></li>
<li><p><strong>JSON structure</strong>: The parsed message must be a
JSON object (list). The <code>type</code> field must be a scalar
string.</p></li>
<li><p><strong>Tool call validation</strong>: For
<code>type: "tool_call"</code> messages, the <code>tool</code> field
must be a scalar string matching the regex
<code>^[A-Za-z.][A-Za-z0-9_.]*$</code> (valid R identifier). The
<code>args</code> field must be a list or null.</p></li>
<li><p><strong>Tool name allowlist</strong>: The tool name is looked up
in the registered tool functions (<code>private$tool_fns</code>).
Unknown tools return an error to the child.</p></li>
<li><p><strong>Tool call rate limiting</strong>:
<code>$execute(code, max_tool_calls = N)</code> caps the number of tool
calls per execution. Exceeding the limit raises an error and halts
execution.</p></li>
</ol>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"while(TRUE) add(1, 1)"</span>, max_tool_calls <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Maximum tool calls (100) exceeded</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="layer-6-environment-sanitization">Layer 6: Environment sanitization<a class="anchor" aria-label="anchor" href="#layer-6-environment-sanitization"></a>
</h3>
<p>The child process inherits only an allowlisted set of environment
variables. All others are set to <code>NA</code> (which callr interprets
as “remove from child environment”):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Allowlisted variables:</span></span>
<span><span class="va">safe_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"PATH"</span>, <span class="st">"HOME"</span>, <span class="st">"USER"</span>, <span class="st">"LOGNAME"</span>, <span class="st">"LANG"</span>, <span class="st">"LC_ALL"</span>, <span class="st">"LC_CTYPE"</span>,</span>
<span>  <span class="st">"LC_MESSAGES"</span>, <span class="st">"LC_COLLATE"</span>, <span class="st">"LC_MONETARY"</span>, <span class="st">"LC_NUMERIC"</span>, <span class="st">"LC_TIME"</span>,</span>
<span>  <span class="st">"SHELL"</span>, <span class="st">"TMPDIR"</span>, <span class="st">"TZ"</span>, <span class="st">"TERM"</span>,</span>
<span>  <span class="st">"R_HOME"</span>, <span class="st">"R_LIBS"</span>, <span class="st">"R_LIBS_SITE"</span>, <span class="st">"R_LIBS_USER"</span>,</span>
<span>  <span class="st">"R_PLATFORM"</span>, <span class="st">"R_ARCH"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Everything not on this list is removed. This means:</p>
<ul>
<li>
<code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code> –
not inherited</li>
<li>
<code>GITHUB_TOKEN</code>, <code>OPENAI_API_KEY</code> – not
inherited</li>
<li>
<code>DATABASE_URL</code>, <code>REDIS_URL</code> – not
inherited</li>
<li>Any custom <code>SECRET_*</code> or <code>API_*</code> variables –
not inherited</li>
</ul>
<p>Two securer-specific variables are added: <code>SECURER_SOCKET</code>
(socket path) and <code>SECURER_TOKEN</code> (authentication token).</p>
</div>
<div class="section level3">
<h3 id="layer-7-tool-argument-validation">Layer 7: Tool argument validation<a class="anchor" aria-label="anchor" href="#layer-7-tool-argument-validation"></a>
</h3>
<p>Two layers of argument validation, on both sides of the trust
boundary:</p>
<p><strong>Parent-side</strong> (in <code>run_with_tools()</code>): If
argument metadata exists for the called tool, any argument names not in
the expected set are rejected with an error sent back to the child. This
prevents the child from passing unexpected arguments to tool
functions.</p>
<p><strong>Child-side</strong> (in generated wrapper functions): When
tool arguments have type annotations (e.g.,
<code>args = list(x = "numeric")</code>), the generated wrapper includes
runtime type checks that run before the IPC call:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generated wrapper for a tool with typed args:</span></span>
<span><span class="va">add</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Tool 'add': argument 'a' must be numeric, got "</span>,</span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Tool 'add': argument 'b' must be numeric, got "</span>,</span>
<span>                            <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, call. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu">.securer_call_tool</span><span class="op">(</span><span class="st">"add"</span>, a <span class="op">=</span> <span class="va">a</span>, b <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="layer-8-code-pre-validation">Layer 8: Code pre-validation<a class="anchor" aria-label="anchor" href="#layer-8-code-pre-validation"></a>
</h3>
<p>Before sending code to the child, <code><a href="../reference/validate_code.html">validate_code()</a></code>
performs two checks:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Syntax check</strong>: <code>parse(text = code)</code>
catches syntax errors immediately, avoiding a round-trip to the child
process.</p></li>
<li><p><strong>Dangerous pattern warnings</strong>: Regex-based
detection of calls to <code><a href="https://rdrr.io/r/base/system.html" class="external-link">system()</a></code>, <code><a href="https://rdrr.io/r/base/system2.html" class="external-link">system2()</a></code>,
<code><a href="https://rdrr.io/r/base/Internal.html" class="external-link">.Internal()</a></code>, <code><a href="https://rdrr.io/r/base/CallExternal.html" class="external-link">.Call()</a></code>, <code><a href="https://rdrr.io/r/base/dynload.html" class="external-link">dyn.load()</a></code>,
<code><a href="https://rdrr.io/r/base/connections.html" class="external-link">pipe()</a></code>, <code><a href="http://processx.r-lib.org/reference/run.html" class="external-link">processx::run()</a></code>,
<code><a href="https://callr.r-lib.org/reference/r.html" class="external-link">callr::r()</a></code>, <code><a href="https://rdrr.io/r/base/connections.html" class="external-link">socketConnection()</a></code>,
<code><a href="https://rdrr.io/r/base/connections.html" class="external-link">url()</a></code>, and <code><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call()</a></code>.</p></li>
</ol>
<p><strong>These warnings are advisory only.</strong> They are not a
security boundary. The regex matching produces both false positives
(<code>"system() is a function"</code> in a string) and false negatives
(indirect invocation via <code>get("system")()</code>). The OS-level
sandbox is the actual enforcement layer.</p>
</div>
<div class="section level3">
<h3 id="layer-9-socket-directory-permissions">Layer 9: Socket directory permissions<a class="anchor" aria-label="anchor" href="#layer-9-socket-directory-permissions"></a>
</h3>
<p>The socket directory (<code>/tmp/securer_XXXXX/</code>) is created
with mode <code>0700</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">socket_dir</span>, mode <span class="op">=</span> <span class="st">"0700"</span><span class="op">)</span></span></code></pre></div>
<p>Only the owning user can list, read, or write files in this
directory. This prevents other users on a shared system from connecting
to the Unix domain socket. Combined with the authentication token (Layer
4), a connection from an unauthorized process is rejected even if it
somehow obtains a file descriptor to the socket.</p>
</div>
<div class="section level3">
<h3 id="layer-10-child-runtime-hardening">Layer 10: Child runtime hardening<a class="anchor" aria-label="anchor" href="#layer-10-child-runtime-hardening"></a>
</h3>
<p>After the child runtime code is injected, key bindings are locked to
prevent the child from redefining them:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In child_runtime_code():</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockEnvironment</a></span><span class="op">(</span><span class="va">.securer_env</span>, bindings <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding</a></span><span class="op">(</span><span class="st">".securer_call_tool"</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding</a></span><span class="op">(</span><span class="st">".securer_connect"</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding</a></span><span class="op">(</span><span class="st">".securer_env"</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">globalenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding()</a></code> prevents reassignment via
<code>&lt;-</code> or <code><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign()</a></code>.
<code><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockEnvironment()</a></code> with <code>bindings = TRUE</code>
prevents modifying <code>.securer_env$conn</code> or
<code>.securer_env$socket_path</code>.</p>
<p>This means the child code cannot:</p>
<ul>
<li>Redefine <code>.securer_call_tool()</code> to bypass argument
validation</li>
<li>Modify <code>.securer_env$conn</code> to point to a different
socket</li>
<li>Replace <code>.securer_connect()</code> to alter the connection
flow</li>
</ul>
<p>Note: Tool wrapper functions (e.g., <code>add()</code>,
<code>get_weather()</code>) injected by
<code><a href="../reference/generate_tool_wrappers.html">generate_tool_wrappers()</a></code> are <strong>not</strong> locked.
Child code can redefine these, but doing so only affects the child’s own
calling convention. The parent-side tool name allowlist and argument
validation still apply.</p>
</div>
</div>
<div class="section level2">
<h2 id="what-the-sandbox-prevents">What the sandbox prevents<a class="anchor" aria-label="anchor" href="#what-the-sandbox-prevents"></a>
</h2>
<p>Concrete outcomes for specific attack scenarios:</p>
<table class="table">
<colgroup>
<col width="15%">
<col width="29%">
<col width="37%">
<col width="17%">
</colgroup>
<thead><tr class="header">
<th>Attack</th>
<th>Linux (bwrap)</th>
<th>macOS (Seatbelt)</th>
<th>Windows</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Read <code>/etc/passwd</code>
</td>
<td>Blocked – not mounted</td>
<td>Allowed – broad <code>/usr</code> read includes <code>/etc</code>
indirectly, but specific <code>/etc</code> reads are allowlisted;
<code>/etc/passwd</code> is not on the allowlist, so it depends on
<code>file-read-metadata</code> vs <code>file-read*</code> rules. In
practice: <strong>readable</strong> (metadata allowed globally, and
<code>/etc/passwd</code> may be accessible via system library
paths)</td>
<td>N/A (no <code>/etc/passwd</code>)</td>
</tr>
<tr class="even">
<td>Read <code>~/.ssh/id_rsa</code>
</td>
<td>Blocked – home dir not mounted</td>
<td>Blocked – home dir not in any allowed read subpath</td>
<td><strong>Not blocked</strong></td>
</tr>
<tr class="odd">
<td>Write <code>~/evil.txt</code>
</td>
<td>Blocked – root is read-only, home not mounted</td>
<td>Blocked – writes only allowed to temp dirs</td>
<td><strong>Not blocked</strong></td>
</tr>
<tr class="even">
<td>Outbound HTTP request</td>
<td>Blocked – no network namespace</td>
<td>Blocked – <code>(deny network* (remote ip))</code>
</td>
<td><strong>Not blocked</strong></td>
</tr>
<tr class="odd">
<td>Fork bomb (<code>repeat fork()</code>)</td>
<td>Limited – <code>ulimit -u 50</code> caps processes</td>
<td>Limited – <code>ulimit -u 50</code> caps processes</td>
<td>Limited – Job Object <code>ActiveProcessLimit</code>
</td>
</tr>
<tr class="even">
<td>Allocate 10 GB RAM</td>
<td>Limited – <code>ulimit -v 512MB</code>
</td>
<td>Limited – <code>ulimit -v 512MB</code>
</td>
<td>Limited – Job Object <code>ProcessMemoryLimit</code>
</td>
</tr>
<tr class="odd">
<td>Infinite CPU loop</td>
<td>Limited – <code>ulimit -t 60</code> + wall-clock timeout</td>
<td>Limited – <code>ulimit -t 60</code> + wall-clock timeout</td>
<td>Limited – Job Object <code>PerProcessUserTimeLimit</code> +
wall-clock timeout</td>
</tr>
<tr class="even">
<td>Execute <code>/usr/bin/python</code>
</td>
<td>Blocked – not bind-mounted under allowed paths (only
<code>/usr</code> is mounted, but process exec is limited by
namespace)</td>
<td>Blocked – <code>process-exec</code> restricted to R binaries and
specific POSIX utilities</td>
<td><strong>Not blocked</strong></td>
</tr>
<tr class="odd">
<td>Read env vars (API keys)</td>
<td>Blocked – env sanitized (allowlist)</td>
<td>Blocked – env sanitized (allowlist)</td>
<td>Blocked – env sanitized (allowlist)</td>
</tr>
<tr class="even">
<td>Redefine <code>.securer_call_tool</code>
</td>
<td>Blocked – <code><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding()</a></code>
</td>
<td>Blocked – <code><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding()</a></code>
</td>
<td>Blocked – <code><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding()</a></code>
</td>
</tr>
<tr class="odd">
<td>Write 1 GB file to <code>/tmp</code>
</td>
<td>Limited – <code>ulimit -f 50MB</code>
</td>
<td>Limited – <code>ulimit -f 50MB</code>
</td>
<td>Not limited (no <code>fsize</code> on Windows)</td>
</tr>
<tr class="even">
<td>Open 1000 files</td>
<td>Limited – <code>ulimit -n 256</code>
</td>
<td>Limited – <code>ulimit -n 256</code>
</td>
<td>Not limited (no <code>nofile</code> on Windows)</td>
</tr>
<tr class="odd">
<td>DNS exfiltration</td>
<td>Blocked – no network</td>
<td>Blocked – no remote IP</td>
<td><strong>Not blocked</strong></td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="known-limitations">Known limitations<a class="anchor" aria-label="anchor" href="#known-limitations"></a>
</h2>
<p>This section documents gaps in the security model. These are design
trade-offs, not bugs, but deployers should understand them.</p>
<div class="section level3">
<h3 id="windows-has-no-filesystem-or-network-restrictions">Windows has no filesystem or network restrictions<a class="anchor" aria-label="anchor" href="#windows-has-no-filesystem-or-network-restrictions"></a>
</h3>
<p>The Windows sandbox provides only environment isolation and Job
Object resource limits. The child process can read and write any file
the user account has access to, and can make arbitrary network
connections. Implementing filesystem and network isolation on Windows
would require <code>AppContainer</code> or <code>Windows Sandbox</code>
APIs, which need compiled C/C++ code and potentially elevated
privileges.</p>
<p><strong>Mitigation</strong>: On Windows, run the host process inside
a Docker container or Windows Sandbox to provide the missing isolation
layers.</p>
</div>
<div class="section level3">
<h3 id="macos-seatbelt-allows-broad-file-reads">macOS Seatbelt allows broad file reads<a class="anchor" aria-label="anchor" href="#macos-seatbelt-allows-broad-file-reads"></a>
</h3>
<p>R requires access to system libraries, frameworks, and shared objects
at runtime. The Seatbelt profile allows <code>file-read*</code> on
<code>/usr</code>, <code>/Library/Frameworks</code>,
<code>/System/Library</code>, <code>/opt/homebrew</code>,
<code>/bin</code>, and <code>/dev</code>. This means the child can read
most system files, though not the user’s home directory.</p>
<p>Notably, <code>file-read-metadata</code> is allowed globally (R needs
<code>stat()</code> for path resolution), which means the child can
discover the existence and size of any file, even if it cannot read the
contents.</p>
<p><strong>Mitigation</strong>: Sensitive data should not be stored in
system-wide readable locations. The environment sanitization (Layer 6)
protects credentials stored in environment variables.</p>
</div>
<div class="section level3">
<h3 id="sandbox-exec-is-deprecated-by-apple">
<code>sandbox-exec</code> is deprecated by Apple<a class="anchor" aria-label="anchor" href="#sandbox-exec-is-deprecated-by-apple"></a>
</h3>
<p>Apple has deprecated <code>sandbox-exec</code> and the Seatbelt
profile language. As of macOS 15 (Sequoia), it still functions and is
used by Apple’s own tools, but it could be removed in a future release
with no public replacement for third-party use.</p>
<p><strong>Mitigation</strong>: Monitor macOS release notes. If
<code>sandbox-exec</code> is removed, the fallback path emits a warning
and runs without OS-level sandboxing (resource limits and IPC validation
still apply).</p>
</div>
<div class="section level3">
<h3 id="ulimit-is-per-process-not-per-session">ulimit is per-process, not per-session<a class="anchor" aria-label="anchor" href="#ulimit-is-per-process-not-per-session"></a>
</h3>
<p><code>ulimit</code> values apply to each individual process. A child
that forks inherits the limits, but the fork itself counts as one
process against the <code>nproc</code> limit. The <code>nproc</code>
limit is also per-user, not per-session, so other processes by the same
user count against it.</p>
</div>
<div class="section level3">
<h3 id="ipc-channel-is-not-encrypted">IPC channel is not encrypted<a class="anchor" aria-label="anchor" href="#ipc-channel-is-not-encrypted"></a>
</h3>
<p>Communication between parent and child uses plaintext JSON over the
Unix domain socket. The socket is protected by filesystem permissions
(0700 directory) and the authentication token, but the data is not
encrypted in transit. On a compromised host where an attacker has the
same UID, they could potentially read IPC traffic.</p>
<p><strong>Mitigation</strong>: The socket directory has 0700
permissions and a random name. The authentication token prevents
unauthorized connections. If the host is compromised at the UID level,
the attacker already has access to everything the session can
access.</p>
</div>
<div class="section level3">
<h3 id="code-pre-validation-is-advisory-only">Code pre-validation is advisory only<a class="anchor" aria-label="anchor" href="#code-pre-validation-is-advisory-only"></a>
</h3>
<p>The <code><a href="../reference/validate_code.html">validate_code()</a></code> function uses regex pattern
matching, which:</p>
<ul>
<li>Produces false positives: <code>"system() is useful"</code> (string,
not a call) triggers a warning</li>
<li>Produces false negatives: <code>get("sys" %p% "tem")()</code> or
<code>do.call("system",   list("ls"))</code> evade detection</li>
</ul>
<p>The sandbox is the actual enforcement layer. Pre-validation is a
convenience for catching obvious mistakes, not a security boundary.</p>
</div>
<div class="section level3">
<h3 id="tool-wrapper-functions-are-not-locked">Tool wrapper functions are not locked<a class="anchor" aria-label="anchor" href="#tool-wrapper-functions-are-not-locked"></a>
</h3>
<p>While <code>.securer_call_tool()</code>,
<code>.securer_connect()</code>, and <code>.securer_env</code> are
protected by <code><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding()</a></code>, the generated tool wrapper
functions (e.g., <code>add()</code>, <code>get_weather()</code>) are not
locked. Child code could redefine these:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Child code could do:</span></span>
<span><span class="va">add</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="fu">.securer_call_tool</span><span class="op">(</span><span class="st">"add"</span>, a <span class="op">=</span> <span class="va">a</span> <span class="op">*</span> <span class="fl">1000</span>, b <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span></code></pre></div>
<p>This only affects the child’s own calling convention. The parent-side
argument validation and tool function execution are unaffected. The
child can already call <code>.securer_call_tool()</code> directly with
any arguments, so redefining the wrapper provides no additional
capability.</p>
</div>
<div class="section level3">
<h3 id="session-pooling-multiplies-the-attack-surface">Session pooling multiplies the attack surface<a class="anchor" aria-label="anchor" href="#session-pooling-multiplies-the-attack-surface"></a>
</h3>
<p><code>SecureSessionPool$new(size = 4)</code> creates 4 independent
child processes, each with its own UDS, sandbox config, and resource
limits. A vulnerability in the sandbox affects all pool members. Dead
sessions are auto-restarted on acquire, which means a child that crashes
(e.g., from hitting a resource limit) gets replaced transparently.</p>
</div>
<div class="section level3">
<h3 id="fallback-to-unsandboxed-execution">Fallback to unsandboxed execution<a class="anchor" aria-label="anchor" href="#fallback-to-unsandboxed-execution"></a>
</h3>
<p>When the platform-specific sandbox tool is unavailable
(<code>sandbox-exec</code> not found on macOS, <code>bwrap</code> not
found on Linux), securer falls back to running without OS-level
sandboxing. A warning is emitted, but execution proceeds. The other
defense layers (resource limits, IPC validation, environment
sanitization) still apply.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Warning message:</span></span>
<span><span class="co"># "bwrap (bubblewrap) not found; falling back to unsandboxed session"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-child-can-consume-resources-within-limits">The child can consume resources within limits<a class="anchor" aria-label="anchor" href="#the-child-can-consume-resources-within-limits"></a>
</h3>
<p>Resource limits bound but do not prevent resource use. A child can
still:</p>
<ul>
<li>Allocate up to 512 MB of memory (default)</li>
<li>Use 60 seconds of CPU time (default)</li>
<li>Write files up to 50 MB (default)</li>
<li>Create up to 50 processes (default)</li>
</ul>
<p>If these defaults are too generous for your use case, pass tighter
limits:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  sandbox <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cpu <span class="op">=</span> <span class="fl">5</span>, memory <span class="op">=</span> <span class="fl">64</span> <span class="op">*</span> <span class="fl">1024</span> <span class="op">*</span> <span class="fl">1024</span>, nproc <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lockbinding-can-be-bypassed-via-environments">
<code>lockBinding</code> can be bypassed via environments<a class="anchor" aria-label="anchor" href="#lockbinding-can-be-bypassed-via-environments"></a>
</h3>
<p>R’s <code><a href="https://rdrr.io/r/base/bindenv.html" class="external-link">lockBinding()</a></code> prevents <code>&lt;-</code> and
<code><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign()</a></code> on the global environment, but does not prevent
all forms of modification. For example,
<code>unlockBinding(".securer_call_tool", globalenv())</code> could
remove the lock. However,
<code>lockEnvironment(.securer_env, bindings = TRUE)</code> uses a
stronger mechanism that cannot be unlocked for the
<code>.securer_env</code> environment.</p>
<p>The practical impact is low: even if a child redefines
<code>.securer_call_tool()</code>, it can only change how it constructs
IPC messages. The parent validates all messages independently.</p>
</div>
</div>
<div class="section level2">
<h2 id="ipc-protocol-details">IPC protocol details<a class="anchor" aria-label="anchor" href="#ipc-protocol-details"></a>
</h2>
<div class="section level3">
<h3 id="transport">Transport<a class="anchor" aria-label="anchor" href="#transport"></a>
</h3>
<ul>
<li>
<strong>Socket type</strong>: Unix domain socket (AF_UNIX,
SOCK_STREAM)</li>
<li>
<strong>Socket path</strong>:
<code>/tmp/securer_XXXXX/ipc.sock</code> (Unix) or
<code>%TEMP%\securer_XXXXX\ipc.sock</code> (Windows)</li>
<li>
<strong>Path length</strong>: Uses <code>/tmp</code> directly to
stay under the ~104 character limit for Unix domain socket paths on
macOS (<code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code> can be deeply nested during
<code>R CMD check</code>)</li>
<li>
<strong>Direction</strong>: Bidirectional. Parent creates server,
child connects.</li>
<li>
<strong>Library</strong>:
<code><a href="http://processx.r-lib.org/reference/processx_sockets.html" class="external-link">processx::conn_create_unix_socket()</a></code> /
<code><a href="http://processx.r-lib.org/reference/processx_sockets.html" class="external-link">processx::conn_connect_unix_socket()</a></code>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="connection-lifecycle">Connection lifecycle<a class="anchor" aria-label="anchor" href="#connection-lifecycle"></a>
</h3>
<ol style="list-style-type: decimal">
<li>Parent creates server socket at
<code>/tmp/securer_XXXXX/ipc.sock</code>
</li>
<li>Parent starts child process (via
<code>callr::r_session$new()</code>)</li>
<li>Child runtime code connects to the socket path from
<code>SECURER_SOCKET</code> env var</li>
<li>Parent accepts the connection
(<code><a href="http://processx.r-lib.org/reference/processx_sockets.html" class="external-link">processx::conn_accept_unix_socket()</a></code> – transitions the
server connection in-place, does not return a new object)</li>
<li>Child sends the authentication token (from
<code>SECURER_TOKEN</code> env var)</li>
<li>Parent validates the token; rejects on mismatch</li>
</ol>
</div>
<div class="section level3">
<h3 id="message-format">Message format<a class="anchor" aria-label="anchor" href="#message-format"></a>
</h3>
<p>Newline-delimited JSON. Each message is a single line terminated by
<code>\n</code>.</p>
<p><strong>Tool call (child to parent):</strong></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">{</span><span class="dt">"type"</span><span class="fu">:</span><span class="st">"tool_call"</span><span class="fu">,</span><span class="dt">"tool"</span><span class="fu">:</span><span class="st">"add"</span><span class="fu">,</span><span class="dt">"args"</span><span class="fu">:{</span><span class="dt">"a"</span><span class="fu">:</span><span class="dv">1</span><span class="fu">,</span><span class="dt">"b"</span><span class="fu">:</span><span class="dv">2</span><span class="fu">}}</span></span></code></pre></div>
<p><strong>Tool response (parent to child):</strong></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">{</span><span class="dt">"value"</span><span class="fu">:</span><span class="dv">3</span><span class="fu">}</span></span></code></pre></div>
<p><strong>Tool error (parent to child):</strong></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="fu">{</span><span class="dt">"error"</span><span class="fu">:</span><span class="st">"Unknown tool: nonexistent"</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="flow">Flow<a class="anchor" aria-label="anchor" href="#flow"></a>
</h3>
<p>The protocol is synchronous. The child blocks on a socket read after
sending a tool call. The parent executes the tool function with full
host privileges, then writes the result back. The child resumes with the
return value.</p>
<pre><code>Child                           Parent
  |                               |
  |--- tool_call JSON -----------&gt;|
  |   (child blocks on read)      |-- validate message
  |                               |-- validate tool name
  |                               |-- validate arg names
  |                               |-- execute tool fn
  |&lt;-- result JSON ---------------|
  |   (child resumes)             |</code></pre>
<p>There is no multiplexing or out-of-order execution. Each tool call is
a synchronous request/response pair.</p>
</div>
<div class="section level3">
<h3 id="timeout-behavior">Timeout behavior<a class="anchor" aria-label="anchor" href="#timeout-behavior"></a>
</h3>
<p>The parent’s event loop polls the UDS and the child process in a loop
with 200ms intervals. If a wall-clock deadline is set, the loop checks
remaining time each iteration. When the deadline expires, the child is
killed, the IPC connection is torn down, and a new session is
started.</p>
</div>
</div>
<div class="section level2">
<h2 id="recommendations-for-deployers">Recommendations for deployers<a class="anchor" aria-label="anchor" href="#recommendations-for-deployers"></a>
</h2>
<div class="section level3">
<h3 id="always-use-sandbox-true-in-production">Always use <code>sandbox = TRUE</code> in production<a class="anchor" aria-label="anchor" href="#always-use-sandbox-true-in-production"></a>
</h3>
<p>Without the sandbox, the child process has the same privileges as the
parent. This includes full filesystem access, network access, and
process execution.</p>
</div>
<div class="section level3">
<h3 id="set-explicit-resource-limits">Set explicit resource limits<a class="anchor" aria-label="anchor" href="#set-explicit-resource-limits"></a>
</h3>
<p>Even with the sandbox enabled, set limits appropriate to your
workload:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  sandbox <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    cpu <span class="op">=</span> <span class="fl">10</span>,                      <span class="co"># 10 seconds CPU</span></span>
<span>    memory <span class="op">=</span> <span class="fl">128</span> <span class="op">*</span> <span class="fl">1024</span> <span class="op">*</span> <span class="fl">1024</span>,    <span class="co"># 128 MB</span></span>
<span>    fsize <span class="op">=</span> <span class="fl">10</span> <span class="op">*</span> <span class="fl">1024</span> <span class="op">*</span> <span class="fl">1024</span>,      <span class="co"># 10 MB max file</span></span>
<span>    nproc <span class="op">=</span> <span class="fl">10</span>,                    <span class="co"># 10 processes</span></span>
<span>    nofile <span class="op">=</span> <span class="fl">64</span>                    <span class="co"># 64 open files</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The defaults (60s CPU, 512 MB memory, 50 MB file, 50 processes, 256
files) are intentionally generous to avoid breaking legitimate
workloads. Tighten them based on what your LLM-generated code actually
needs.</p>
</div>
<div class="section level3">
<h3 id="use-execution-timeouts">Use execution timeouts<a class="anchor" aria-label="anchor" href="#use-execution-timeouts"></a>
</h3>
<p>Always pass a <code>timeout</code> to <code>$execute()</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="va">llm_code</span>, timeout <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p>This catches cases where <code>ulimit -t</code> does not apply (e.g.,
the child is blocked on I/O, sleeping, or waiting for a lock).</p>
</div>
<div class="section level3">
<h3 id="use-max_tool_calls-to-prevent-loops">Use <code>max_tool_calls</code> to prevent loops<a class="anchor" aria-label="anchor" href="#use-max_tool_calls-to-prevent-loops"></a>
</h3>
<p>If the LLM generates code that calls a tool in a tight loop, it can
overwhelm the host. Set a cap:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="va">llm_code</span>, timeout <span class="op">=</span> <span class="fl">30</span>, max_tool_calls <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="review-tool-functions-carefully">Review tool functions carefully<a class="anchor" aria-label="anchor" href="#review-tool-functions-carefully"></a>
</h3>
<p>Tool functions execute on the host with full privileges. A tool that
runs arbitrary SQL, writes to arbitrary paths, or makes unconstrained
API calls undermines the sandbox. Apply the principle of least privilege
to each tool:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># BAD: arbitrary SQL</span></span>
<span><span class="fu"><a href="../reference/securer_tool.html">securer_tool</a></span><span class="op">(</span><span class="st">"query"</span>, <span class="st">"Run SQL"</span>,</span>
<span>  fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">sql</span><span class="op">)</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">conn</span>, <span class="va">sql</span><span class="op">)</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sql <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># BETTER: parameterized query with allowlist</span></span>
<span><span class="fu"><a href="../reference/securer_tool.html">securer_tool</a></span><span class="op">(</span><span class="st">"get_user"</span>, <span class="st">"Look up user by ID"</span>,</span>
<span>  fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">user_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">user_id</span><span class="op">)</span>, <span class="va">user_id</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">conn</span>, <span class="st">"SELECT name, email FROM users WHERE id = ?"</span>,</span>
<span>                    params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">user_id</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>user_id <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="enable-audit-logging">Enable audit logging<a class="anchor" aria-label="anchor" href="#enable-audit-logging"></a>
</h3>
<p>For compliance and incident investigation, enable the file-based
audit log:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  sandbox <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  audit_log <span class="op">=</span> <span class="st">"/var/log/securer/audit.jsonl"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Each entry is a JSON object with a timestamp, event type, and session
ID:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="fu">{</span><span class="dt">"timestamp"</span><span class="fu">:</span><span class="st">"2025-01-15T10:30:00.123Z"</span><span class="fu">,</span><span class="dt">"event"</span><span class="fu">:</span><span class="st">"tool_call"</span><span class="fu">,</span><span class="dt">"session_id"</span><span class="fu">:</span><span class="st">"sess_abc123"</span><span class="fu">,</span><span class="dt">"tool"</span><span class="fu">:</span><span class="st">"add"</span><span class="fu">,</span><span class="dt">"args"</span><span class="fu">:{</span><span class="dt">"a"</span><span class="fu">:</span><span class="dv">1</span><span class="fu">,</span><span class="dt">"b"</span><span class="fu">:</span><span class="dv">2</span><span class="fu">}}</span></span></code></pre></div>
<p>Events logged: <code>session_start</code>,
<code>session_close</code>, <code>execute_start</code>,
<code>execute_complete</code>, <code>execute_error</code>,
<code>execute_timeout</code>, <code>tool_call</code>,
<code>tool_result</code>.</p>
</div>
<div class="section level3">
<h3 id="on-windows-use-container-isolation">On Windows, use container isolation<a class="anchor" aria-label="anchor" href="#on-windows-use-container-isolation"></a>
</h3>
<p>Since the Windows sandbox does not restrict filesystem or network
access, run the host process inside a Docker container (with Windows
containers) or WSL2 with bwrap to get the missing isolation layers.</p>
</div>
<div class="section level3">
<h3 id="monitor-for-sandbox-fallback-warnings">Monitor for sandbox fallback warnings<a class="anchor" aria-label="anchor" href="#monitor-for-sandbox-fallback-warnings"></a>
</h3>
<p>If <code>sandbox-exec</code> or <code>bwrap</code> is not installed,
securer falls back to unsandboxed execution with a warning. In
production, treat this warning as a deployment error. Ensure sandbox
tools are installed and on PATH before starting sessions.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Verify sandbox tooling is available:</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"sysname"</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="st">"Linux"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.which.html" class="external-link">Sys.which</a></span><span class="op">(</span><span class="st">"bwrap"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"sysname"</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="st">"Darwin"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="st">"/usr/bin/sandbox-exec"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ian Flores Siaca.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
