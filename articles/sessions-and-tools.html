<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Sessions and Tools • securer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sessions and Tools">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">securer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ian-flores/securer"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Sessions and Tools</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ian-flores/securer/blob/main/vignettes/sessions-and-tools.Rmd" class="external-link"><code>vignettes/sessions-and-tools.Rmd</code></a></small>
      <div class="d-none name"><code>sessions-and-tools.Rmd</code></div>
    </div>

    
    
<p>This vignette covers session lifecycle, output handling, audit
logging, and session pooling. See also
<code><a href="../articles/quickstart.html">vignette("quickstart")</a></code> and
<code><a href="../articles/security-model.html">vignette("security-model")</a></code>.</p>
<div class="section level2">
<h2 id="persistent-sessions">Persistent sessions<a class="anchor" aria-label="anchor" href="#persistent-sessions"></a>
</h2>
<p><code>SecureSession</code> keeps a child R process alive across
multiple <code>$execute()</code> calls. State persists between
executions:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ian-flores.github.io/securer/">securer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">tools</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/securer_tool.html">securer_tool</a></span><span class="op">(</span><span class="st">"add"</span>, <span class="st">"Add two numbers"</span>,</span>
<span>    fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="va">a</span> <span class="op">+</span> <span class="va">b</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="st">"numeric"</span>, b <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>tools <span class="op">=</span> <span class="va">tools</span>, sandbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"x &lt;- add(10, 20)"</span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"x * 2"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 60</span></span>
<span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Always call <code>$close()</code> when done, or use
<code><a href="../reference/with_secure_session.html">with_secure_session()</a></code> for automatic cleanup:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_secure_session.html">with_secure_session</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"x &lt;- 10"</span><span class="op">)</span></span>
<span>  <span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"x * 2"</span><span class="op">)</span></span>
<span><span class="op">}</span>, sandbox <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="safety-features-for-agent-workflows">Safety features for agent workflows<a class="anchor" aria-label="anchor" href="#safety-features-for-agent-workflows"></a>
</h2>
<p><code>SecureSession</code> includes features for hardening LLM agent
deployments:</p>
<ul>
<li>
<strong><code>max_code_length</code></strong>
(<code>$execute()</code>): Reject code exceeding a character limit
(default 100,000).</li>
<li>
<strong><code>max_executions</code></strong> (<code>$new()</code>):
Cap total <code>$execute()</code> calls per session.</li>
<li>
<strong><code>pre_execute_hook</code></strong>
(<code>$new()</code>): Callback returning <code>FALSE</code> to block
execution.</li>
<li>
<strong><code>sanitize_errors</code></strong> (<code>$new()</code>):
Strip paths, PIDs, and hostnames from errors.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  max_executions <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  pre_execute_hook <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">code</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Block code that mentions system()</span></span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"system\\("</span>, <span class="va">code</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  sanitize_errors <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>See <code><a href="../articles/security-model.html">vignette("security-model")</a></code> for the full threat model
and defense layers.</p>
</div>
<div class="section level2">
<h2 id="execution-timeouts">Execution timeouts<a class="anchor" aria-label="anchor" href="#execution-timeouts"></a>
</h2>
<p><code>$execute()</code> accepts a <code>timeout</code> in seconds
(default 30). On timeout the child is killed and the session
auto-recovers:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"Sys.sleep(60)"</span>, timeout <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Execution timed out</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">is_alive</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="error-handling">Error handling<a class="anchor" aria-label="anchor" href="#error-handling"></a>
</h2>
<p>Errors in the child process, in tool execution, and from unknown tool
names are all propagated to the host as standard R errors:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/execute_r.html">execute_r</a></span><span class="op">(</span><span class="st">'stop("something went wrong")'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: something went wrong</span></span>
<span></span>
<span><span class="fu"><a href="../reference/execute_r.html">execute_r</a></span><span class="op">(</span><span class="st">"nonexistent_tool()"</span>, tools <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Unknown tool: nonexistent_tool</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="streaming-output">Streaming output<a class="anchor" aria-label="anchor" href="#streaming-output"></a>
</h2>
<p>Pass <code>output_handler</code> to receive child output as it
arrives:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span></span>
<span>  <span class="st">'for (i in 1:5) cat("Step", i, "\\n")'</span>,</span>
<span>  output_handler <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">line</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"[child] "</span>, <span class="va">line</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Output is always available as <code>attr(result, "output")</code> on
the return value.</p>
</div>
<div class="section level2">
<h2 id="output-and-tool-call-limits">Output and tool call limits<a class="anchor" aria-label="anchor" href="#output-and-tool-call-limits"></a>
</h2>
<p>Both <code>max_output_lines</code> and <code>max_tool_calls</code>
are per-execution caps:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cap accumulated output lines</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span></span>
<span>  <span class="st">'for (i in 1:1000) cat("line", i, "\\n")'</span>,</span>
<span>  max_output_lines <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Cap tool calls in one execution</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"for (i in 1:10) add(i, i)"</span>, max_tool_calls <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: Maximum tool calls (5) exceeded</span></span>
<span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="session-lifecycle">Session lifecycle<a class="anchor" aria-label="anchor" href="#session-lifecycle"></a>
</h2>
<p><code>$restart()</code> resets the child process;
<code>$is_alive()</code> checks if it is running:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>sandbox <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"x &lt;- 42"</span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">restart</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># State is gone after restart</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"exists('x')"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">is_alive</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="audit-logging">Audit logging<a class="anchor" aria-label="anchor" href="#audit-logging"></a>
</h2>
<p>Pass <code>audit_log</code> to the constructor to write structured
JSONL entries:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>audit_log <span class="op">=</span> <span class="st">"securer-audit.jsonl"</span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"1 + 1"</span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Each line is a JSON object with <code>timestamp</code>,
<code>event</code>, and <code>session_id</code> fields plus
event-specific data. Events: <code>session_start</code> (pid),
<code>session_close</code>, <code>session_restart</code>,
<code>execute_start</code> (code), <code>execute_complete</code>
(elapsed), <code>execute_error</code> (error),
<code>execute_timeout</code> (timeout_secs), <code>tool_call</code>
(tool, args), <code>tool_result</code> (tool, elapsed). Example:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">{</span><span class="dt">"timestamp"</span><span class="fu">:</span><span class="st">"2024-01-15T10:30:00.000Z"</span><span class="fu">,</span><span class="dt">"event"</span><span class="fu">:</span><span class="st">"tool_call"</span><span class="fu">,</span><span class="dt">"session_id"</span><span class="fu">:</span><span class="st">"sess_abc123"</span><span class="fu">,</span><span class="dt">"tool"</span><span class="fu">:</span><span class="st">"add"</span><span class="fu">,</span><span class="dt">"args"</span><span class="fu">:{</span><span class="dt">"a"</span><span class="fu">:</span><span class="dv">1</span><span class="fu">,</span><span class="dt">"b"</span><span class="fu">:</span><span class="dv">2</span><span class="fu">}}</span></span></code></pre></div>
<p>The log file is created with <code>0600</code> permissions. Code
fields longer than 10,000 characters are truncated.</p>
</div>
<div class="section level2">
<h2 id="session-pooling">Session pooling<a class="anchor" aria-label="anchor" href="#session-pooling"></a>
</h2>
<div class="section level3">
<h3 id="why-session-pooling">Why session pooling?<a class="anchor" aria-label="anchor" href="#why-session-pooling"></a>
</h3>
<p>Creating a <code>SecureSession</code> starts a new R child process,
sets up the sandbox, and establishes the IPC socket. This takes roughly
0.5–1 second per session. For workloads that serve many short-lived
requests — such as a Plumber API or a multi-user Shiny app — creating
and tearing down a session for every request adds significant latency.
Session pooling solves this by pre-warming a fixed number of sessions at
startup and reusing them across requests, eliminating repeated startup
costs and keeping response times low.</p>
</div>
<div class="section level3">
<h3 id="session-pool-lifecycle">Session pool lifecycle<a class="anchor" aria-label="anchor" href="#session-pool-lifecycle"></a>
</h3>
<pre><code> Initialize          Acquire            Execute           Release
+-------------+   +-------------+   +-------------+   +-------------+
| Pre-warm N  |--&gt;| Caller gets |--&gt;| Run code in |--&gt;| Return to   |
| sessions at |   | idle session|   | acquired    |   | idle pool   |
| startup     |   | from pool   |   | session     |   | (or restart |
|             |   |             |   |             |   |  if dead)   |
+-------------+   +-------------+   +-------------+   +-------------+</code></pre>
<p><code>SecureSessionPool</code> pre-warms multiple sessions for
low-latency execution:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pool</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSessionPool.html">SecureSessionPool</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span>, sandbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pool</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"1 + 1"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span></span>
<span><span class="va">pool</span><span class="op">$</span><span class="fu">status</span><span class="op">(</span><span class="op">)</span>  <span class="co"># returns list(total, busy, idle, dead)</span></span>
<span><span class="va">pool</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Set <code>reset_between_uses = TRUE</code> to restart sessions after
each execution, preventing state leakage between callers:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pool</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSessionPool.html">SecureSessionPool</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  sandbox <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  reset_between_uses <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pool</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"x &lt;- 99"</span><span class="op">)</span></span>
<span><span class="va">pool</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="st">"exists('x')"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span></span>
<span><span class="va">pool</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Dead sessions are automatically restarted on acquire. The pool is
<strong>not</strong> thread-safe — create separate instances when using
<code>parallel</code> or <code>future</code>.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ian Flores Siaca.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
