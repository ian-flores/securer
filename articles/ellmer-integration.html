<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using securer with ellmer • securer</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using securer with ellmer">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">securer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/ellmer-integration.html">Using securer with ellmer</a></li>
    <li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with securer</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ian-flores/securer"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Using securer with ellmer</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ian-flores/securer/blob/main/vignettes/ellmer-integration.Rmd" class="external-link"><code>vignettes/ellmer-integration.Rmd</code></a></small>
      <div class="d-none name"><code>ellmer-integration.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p><a href="https://ellmer.tidyverse.org/" class="external-link">ellmer</a> is an R package
for chatting with LLMs. securer integrates with ellmer’s tool-use system
so an LLM can execute R code in a sandboxed child process. The LLM
writes code, securer runs it safely, and the result flows back into the
conversation.</p>
<p><code><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool()</a></code> is the bridge between the two
packages. It wraps a <code>SecureSession</code> as an ellmer tool
definition that you register on a chat object.</p>
</div>
<div class="section level2">
<h2 id="quick-start">Quick start<a class="anchor" aria-label="anchor" href="#quick-start"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ian-flores.github.io/securer/">securer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ellmer.tidyverse.org" class="external-link">ellmer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_openai.html" class="external-link">chat_openai</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"What is the sum of the first 100 prime numbers?"</span><span class="op">)</span></span></code></pre></div>
<p>That’s it. The LLM receives a tool called <code>execute_r_code</code>
that accepts a <code>code</code> string. When the model decides to use
it, securer runs the code in a sandboxed child process and returns the
result. The sandbox blocks filesystem writes and network access — the
LLM can compute but not exfiltrate.</p>
</div>
<div class="section level2">
<h2 id="how-it-works">How it works<a class="anchor" aria-label="anchor" href="#how-it-works"></a>
</h2>
<p>When you call <code><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool()</a></code>, securer:</p>
<ol style="list-style-type: decimal">
<li>Creates a <code>SecureSession</code> (or uses one you provide)</li>
<li>Returns an ellmer <code>ToolDef</code> object with a single
<code>code</code> argument</li>
<li>The LLM sees the tool’s description and can choose to call it</li>
</ol>
<p>When the LLM invokes the tool:</p>
<pre><code>LLM generates: execute_r_code(code = "mean(1:100)")
    |
    v
ellmer calls securer's executor function
    |
    v
securer sends code to sandboxed child process
    |
    v
Child evaluates code, returns result
    |
    v
securer formats result as a string
    |
    v
ellmer passes result back to LLM
    |
    v
LLM incorporates result into its response</code></pre>
<p>Errors in the child (syntax errors, runtime errors, timeouts) are
caught and returned as <code>ContentToolResult(error = ...)</code>. This
tells the LLM something went wrong without crashing the chat loop — the
model can try again or explain the error.</p>
</div>
<div class="section level2">
<h2 id="adding-securer-tools">Adding securer tools<a class="anchor" aria-label="anchor" href="#adding-securer-tools"></a>
</h2>
<p>The real power comes from giving the LLM access to your own
functions. Define securer tools and pass them in:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tools</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/securer_tool.html">securer_tool</a></span><span class="op">(</span><span class="st">"query_db"</span>, <span class="st">"Query a database table by name"</span>,</span>
<span>    fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">table</span>, <span class="va">limit</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbConnect</span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">SQLite</span><span class="op">(</span><span class="op">)</span>, <span class="st">"data.db"</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"SELECT * FROM %s LIMIT %d"</span>, <span class="va">table</span>, <span class="va">limit</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>table <span class="op">=</span> <span class="st">"character"</span>, limit <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="fu"><a href="../reference/securer_tool.html">securer_tool</a></span><span class="op">(</span><span class="st">"list_tables"</span>, <span class="st">"List available database tables"</span>,</span>
<span>    fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbConnect</span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu">SQLite</span><span class="op">(</span><span class="op">)</span>, <span class="st">"data.db"</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbListTables</span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_openai.html" class="external-link">chat_openai</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span>tools <span class="op">=</span> <span class="va">tools</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"What tables are available? Show me the first 5 rows of each."</span><span class="op">)</span></span></code></pre></div>
<p>The LLM’s code runs sandboxed, but <code>query_db()</code> and
<code>list_tables()</code> execute on the host with full database
access. The sandbox ensures the LLM can only interact with your data
through the tools you define.</p>
</div>
<div class="section level2">
<h2 id="configuring-the-session">Configuring the session<a class="anchor" aria-label="anchor" href="#configuring-the-session"></a>
</h2>
<p><code><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool()</a></code> accepts the same configuration
as <code>SecureSession</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tool_def</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span></span>
<span>  tools <span class="op">=</span> <span class="va">tools</span>,</span>
<span>  sandbox <span class="op">=</span> <span class="cn">TRUE</span>,       <span class="co"># OS-level sandbox (default)</span></span>
<span>  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>        <span class="co"># Resource limits</span></span>
<span>    cpu <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    memory <span class="op">=</span> <span class="fl">512</span> <span class="op">*</span> <span class="fl">1024</span> <span class="op">*</span> <span class="fl">1024</span></span>
<span>  <span class="op">)</span>,</span>
<span>  timeout <span class="op">=</span> <span class="fl">15</span>          <span class="co"># Per-execution timeout in seconds (default: 30)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="sandbox">Sandbox<a class="anchor" aria-label="anchor" href="#sandbox"></a>
</h3>
<p>With <code>sandbox = TRUE</code> (the default), the child process
runs inside an OS-level sandbox:</p>
<ul>
<li>
<strong>macOS</strong>: Seatbelt blocks network access and
filesystem writes outside <code>/tmp</code>
</li>
<li>
<strong>Linux</strong>: bubblewrap provides full namespace
isolation</li>
<li>
<strong>Windows</strong>: Environment-variable isolation only (a
warning is issued)</li>
</ul>
<p>Set <code>sandbox = FALSE</code> if you trust the LLM’s code or are
running in an environment where sandboxing isn’t available.</p>
</div>
<div class="section level3">
<h3 id="resource-limits">Resource limits<a class="anchor" aria-label="anchor" href="#resource-limits"></a>
</h3>
<p>The <code>limits</code> argument applies <code>ulimit</code>-based
caps to the child process. This prevents the LLM from writing code that
consumes all available CPU or memory:</p>
<table class="table">
<thead><tr class="header">
<th>Limit</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>cpu</code></td>
<td>CPU time (seconds)</td>
</tr>
<tr class="even">
<td><code>memory</code></td>
<td>Virtual memory (bytes)</td>
</tr>
<tr class="odd">
<td><code>fsize</code></td>
<td>Max file size (bytes)</td>
</tr>
<tr class="even">
<td><code>nproc</code></td>
<td>Max processes</td>
</tr>
<tr class="odd">
<td><code>nofile</code></td>
<td>Max open files</td>
</tr>
<tr class="even">
<td><code>stack</code></td>
<td>Stack size (bytes)</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="timeout">Timeout<a class="anchor" aria-label="anchor" href="#timeout"></a>
</h3>
<p>The <code>timeout</code> parameter (default 30 seconds) sets a
wall-clock deadline for each code execution. If the LLM writes an
infinite loop, securer kills the child process and returns an error to
ellmer. The session automatically recovers and is reusable for
subsequent tool calls.</p>
</div>
</div>
<div class="section level2">
<h2 id="using-a-pre-existing-session">Using a pre-existing session<a class="anchor" aria-label="anchor" href="#using-a-pre-existing-session"></a>
</h2>
<p>If you need more control over the session lifecycle, create one
yourself and pass it in:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">session</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSession.html">SecureSession</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  tools <span class="op">=</span> <span class="va">tools</span>,</span>
<span>  sandbox <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># Log tool calls and execution timing</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_openai.html" class="external-link">chat_openai</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span>session <span class="op">=</span> <span class="va">session</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"Analyze the sales table and compute monthly totals."</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"Now plot the trend."</span><span class="op">)</span>  <span class="co"># Same session, state persists</span></span>
<span></span>
<span><span class="co"># You own the session --- close it when done</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>When you provide your own session, securer does not create or close
one internally. This is useful when you want:</p>
<ul>
<li>
<strong>Verbose logging</strong> to see tool calls and timing</li>
<li>
<strong>Audit logging</strong>
(<code>audit_log = "path.jsonl"</code>) for compliance</li>
<li>
<strong>State persistence</strong> across multiple chat turns</li>
<li>
<strong>Session reuse</strong> across multiple chat objects</li>
</ul>
</div>
<div class="section level2">
<h2 id="result-formatting">Result formatting<a class="anchor" aria-label="anchor" href="#result-formatting"></a>
</h2>
<p>securer converts R values to strings before returning them to the
LLM:</p>
<table class="table">
<thead><tr class="header">
<th>R type</th>
<th>Formatting</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>NULL</code></td>
<td><code>"NULL"</code></td>
</tr>
<tr class="even">
<td>Scalar</td>
<td>
<code><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character()</a></code> (e.g., <code>42</code> →
<code>"42"</code>)</td>
</tr>
<tr class="odd">
<td>Data frame</td>
<td>
<code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> output, truncated at 30 rows</td>
</tr>
<tr class="even">
<td>Other</td>
<td>
<code>capture.output(print())</code>, truncated at 50 lines</td>
</tr>
</tbody>
</table>
<p>Truncation prevents large results from consuming the LLM’s context
window.</p>
</div>
<div class="section level2">
<h2 id="error-handling">Error handling<a class="anchor" aria-label="anchor" href="#error-handling"></a>
</h2>
<p>Errors are surfaced to the LLM as tool errors, not R exceptions. This
means the chat doesn’t crash — the LLM sees the error message and can
react:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_openai.html" class="external-link">chat_openai</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span>sandbox <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The LLM might generate code with a bug. securer catches the error</span></span>
<span><span class="co"># and returns it as a tool result. The LLM sees the error message</span></span>
<span><span class="co"># and can fix its code and try again.</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"Divide 1 by 0 and tell me what happens in R"</span><span class="op">)</span></span></code></pre></div>
<p>Error scenarios handled:</p>
<ul>
<li>
<strong>Syntax errors</strong> in the LLM’s code</li>
<li>
<strong>Runtime errors</strong> (e.g., <code><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop()</a></code>, missing
variables)</li>
<li>
<strong>Timeout</strong> (code runs too long)</li>
<li>
<strong>Dead session</strong> (child process crashed)</li>
<li>
<strong>Type mismatches</strong> in tool arguments (e.g., passing a
string where numeric is expected)</li>
</ul>
<p>In all cases, the LLM receives a descriptive error message and can
decide how to proceed.</p>
</div>
<div class="section level2">
<h2 id="example-data-analysis-assistant">Example: data analysis assistant<a class="anchor" aria-label="anchor" href="#example-data-analysis-assistant"></a>
</h2>
<p>A complete example combining securer, ellmer, and custom tools:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ian-flores.github.io/securer/">securer</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ellmer.tidyverse.org" class="external-link">ellmer</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define tools the LLM can use</span></span>
<span><span class="va">tools</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/securer_tool.html">securer_tool</a></span><span class="op">(</span><span class="st">"load_csv"</span>, <span class="st">"Load a CSV file and return as data frame"</span>,</span>
<span>    fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"File not found: "</span>, <span class="va">path</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="fu"><a href="../reference/securer_tool.html">securer_tool</a></span><span class="op">(</span><span class="st">"save_plot"</span>, <span class="st">"Save the current plot to a PNG file"</span>,</span>
<span>    fn <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">filename</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/grDevices/dev2.html" class="external-link">dev.copy</a></span><span class="op">(</span><span class="va">png</span>, <span class="va">filename</span>, width <span class="op">=</span> <span class="fl">800</span>, height <span class="op">=</span> <span class="fl">600</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Plot saved to"</span>, <span class="va">filename</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>filename <span class="op">=</span> <span class="st">"character"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a sandboxed execution environment</span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_openai.html" class="external-link">chat_openai</a></span><span class="op">(</span></span>
<span>  system_prompt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>    <span class="st">"You are a data analysis assistant."</span>,</span>
<span>    <span class="st">"You have access to an R execution environment via the execute_r_code tool."</span>,</span>
<span>    <span class="st">"Use it to load data, compute statistics, and create visualizations."</span>,</span>
<span>    <span class="st">"Available tools inside R: load_csv(path), save_plot(filename)."</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span></span>
<span>  tools <span class="op">=</span> <span class="va">tools</span>,</span>
<span>  timeout <span class="op">=</span> <span class="fl">60</span>,</span>
<span>  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>memory <span class="op">=</span> <span class="fl">1024</span> <span class="op">*</span> <span class="fl">1024</span> <span class="op">*</span> <span class="fl">1024</span><span class="op">)</span>  <span class="co"># 1 GB</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Multi-turn conversation with persistent state</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"Load sales.csv and show me a summary"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"What's the correlation between price and quantity?"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="st">"Create a scatter plot of price vs quantity"</span><span class="op">)</span></span></code></pre></div>
<p>Each <code>chat$chat()</code> call may trigger multiple rounds of
code execution. The LLM writes code, sees the result, and can write more
code — all within the same sandboxed session with persistent state.</p>
</div>
<div class="section level2">
<h2 id="using-with-other-llm-providers">Using with other LLM providers<a class="anchor" aria-label="anchor" href="#using-with-other-llm-providers"></a>
</h2>
<p>ellmer supports multiple LLM backends. securer works with any of
them:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># OpenAI</span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_openai.html" class="external-link">chat_openai</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Anthropic</span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_anthropic.html" class="external-link">chat_anthropic</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ollama (local)</span></span>
<span><span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_ollama.html" class="external-link">chat_ollama</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"llama3"</span><span class="op">)</span></span>
<span><span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The tool definition is provider-agnostic. Any model that supports
tool use will see <code>execute_r_code</code> and can call it.</p>
</div>
<div class="section level2">
<h2 id="session-pooling">Session pooling<a class="anchor" aria-label="anchor" href="#session-pooling"></a>
</h2>
<p>For applications that handle multiple concurrent users, combine
session pooling with ellmer:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For raw code execution across concurrent users, use the pool directly.</span></span>
<span><span class="co"># pool$execute() handles session acquisition and release internally.</span></span>
<span><span class="va">pool</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SecureSessionPool.html">SecureSessionPool</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">4</span>, tools <span class="op">=</span> <span class="va">tools</span>, sandbox <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">handle_user_code</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">code</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pool</span><span class="op">$</span><span class="fu">execute</span><span class="op">(</span><span class="va">code</span>, timeout <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># For ellmer integration with concurrent users, create a separate</span></span>
<span><span class="co"># SecureSession per request. Each session is cleaned up on GC.</span></span>
<span><span class="va">handle_user_chat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">user_message</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_openai.html" class="external-link">chat_openai</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">tool</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool</a></span><span class="op">(</span>tools <span class="op">=</span> <span class="va">tools</span>, sandbox <span class="op">=</span> <span class="cn">TRUE</span>, timeout <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span>  <span class="va">chat</span><span class="op">$</span><span class="fu">register_tool</span><span class="op">(</span><span class="va">tool</span><span class="op">)</span></span>
<span>  <span class="va">chat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="va">user_message</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The pool pre-warms sessions for low-latency raw code execution via
<code>pool$execute()</code>. For ellmer chat integration,
<code><a href="../reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool()</a></code> creates and manages its own
session (cleaned up automatically when garbage collected).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ian Flores Siaca.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
