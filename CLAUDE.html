<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>securer — Development Guide • securer</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="securer — Development Guide"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">securer</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/ellmer-integration.html">Using securer with ellmer</a></li>
    <li><a class="dropdown-item" href="articles/getting-started.html">Getting Started with securer</a></li>
    <li><a class="dropdown-item" href="articles/security-model.html">Security Model</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ian-flores/securer"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>securer — Development Guide</h1>
      <small class="dont-index">Source: <a href="https://github.com/ian-flores/securer/blob/main/CLAUDE.md" class="external-link"><code>CLAUDE.md</code></a></small>
    </div>

<div id="securer--development-guide" class="section level1">

<div class="section level2">
<h2 id="what-this-is">What This Is<a class="anchor" aria-label="anchor" href="#what-this-is"></a></h2>
<p>An R package for secure LLM code execution. LLMs write R code that calls registered tools as functions. Execution pauses at each tool call, the host fulfills it, and execution resumes. The child R process runs inside an OS sandbox.</p>
</div>
<div class="section level2">
<h2 id="architecture">Architecture<a class="anchor" aria-label="anchor" href="#architecture"></a></h2>
<pre><code>SecureSession (R6)
├── callr::r_session — child R process
├── Unix domain socket — bidirectional IPC (tool calls + responses)
├── Tool registry — securer_tool() objects → child wrapper functions + type checking
├── Sandbox — macOS Seatbelt / Linux bwrap / Windows env isolation
├── Resource limits — ulimit-based CPU, memory, fsize, nproc, nofile, stack
├── Execution timeouts — deadline-based abort with session recovery
├── Verbose logging — optional structured message() output
├── Code pre-validation — syntax check + dangerous pattern warnings
├── Streaming output — capture cat()/print() via piped stdout/stderr
├── File-based audit log — JSONL event log for compliance/debugging
└── ellmer integration — securer_as_ellmer_tool() for LLM chat

SecureSessionPool (R6)
└── Pre-warmed pool of SecureSession instances for low-latency execution</code></pre>
<p>Key files: - <code>R/secure-session.R</code> — Core R6 class, event loop, session lifecycle - <code>R/child-runtime.R</code> — Code string injected into child (<code>.securer_call_tool()</code>) - <code>R/ipc.R</code> — UDS helpers (create, accept, read, write) - <code>R/tool-registry.R</code> — <code><a href="reference/securer_tool.html">securer_tool()</a></code>, validation, wrapper code generation - <code>R/sandbox-macos.R</code> — Seatbelt profile generation + wrapper script - <code>R/sandbox-linux.R</code> — Bubblewrap (bwrap) namespace isolation + wrapper script - <code>R/sandbox-windows.R</code> — Environment-variable-only isolation for Windows - <code>R/rlimits.R</code> — ulimit command generation and validation - <code>R/execute.R</code> — <code><a href="reference/execute_r.html">execute_r()</a></code> convenience function - <code>R/validate.R</code> — Code pre-validation (syntax + dangerous patterns) - <code>R/audit-log.R</code> — JSONL file-based audit logging - <code>R/session-pool.R</code> — SecureSessionPool R6 class - <code>R/ellmer.R</code> — ellmer tool integration (<code><a href="reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool()</a></code>)</p>
</div>
<div class="section level2">
<h2 id="critical-implementation-details">Critical Implementation Details<a class="anchor" aria-label="anchor" href="#critical-implementation-details"></a></h2>
<div class="section level3">
<h3 id="unix-domain-socket-behavior">Unix Domain Socket Behavior<a class="anchor" aria-label="anchor" href="#unix-domain-socket-behavior"></a></h3>
<p><code>processx::conn_accept_unix_socket(server)</code> does NOT return a new connection. It transitions the server connection in-place to “connected_server” state. The same object is used for bidirectional data. This is why <code>SecureSession</code> uses a single <code>ipc_conn</code> field.</p>
</div>
<div class="section level3">
<h3 id="sandbox-wrapper-trick">Sandbox Wrapper Trick<a class="anchor" aria-label="anchor" href="#sandbox-wrapper-trick"></a></h3>
<p><code>callr::r_session_options(arch = "/path/to/wrapper.sh")</code> — callr treats <code>arch</code> values containing <code>/</code> as direct paths to the R binary. We exploit this to inject <code>sandbox-exec -f profile.sb R "$@"</code> as the “R binary.”</p>
</div>
<div class="section level3">
<h3 id="socket-path-length">Socket Path Length<a class="anchor" aria-label="anchor" href="#socket-path-length"></a></h3>
<p>Unix domain sockets are limited to ~104 chars on macOS. We use <code>/tmp</code> directly instead of <code><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir()</a></code> (which can be deeply nested during <code>R CMD check</code>).</p>
</div>
<div class="section level3">
<h3 id="child-runtime">Child Runtime<a class="anchor" aria-label="anchor" href="#child-runtime"></a></h3>
<p><code><a href="reference/child_runtime_code.html">child_runtime_code()</a></code> returns a CHARACTER STRING, not functions. It’s <code>eval(parse(text=...))</code> in the child’s global environment. Tool wrappers are injected the same way after the UDS connects.</p>
</div>
<div class="section level3">
<h3 id="event-loop">Event Loop<a class="anchor" aria-label="anchor" href="#event-loop"></a></h3>
<p><code>run_with_tools()</code> polls the UDS for tool-call JSON and the callr process for completion in a loop with 200ms poll intervals. Tool calls are synchronous: child blocks on UDS read, parent executes tool, writes result back.</p>
</div>
<div class="section level3">
<h3 id="execution-timeouts">Execution Timeouts<a class="anchor" aria-label="anchor" href="#execution-timeouts"></a></h3>
<p><code>$execute(code, timeout = N)</code> tracks elapsed time in the event loop. On timeout, the child process is killed, the UDS is cleaned up, and the session is automatically restarted so it remains usable for subsequent calls.</p>
</div>
<div class="section level3">
<h3 id="tool-argument-type-checking">Tool Argument Type Checking<a class="anchor" aria-label="anchor" href="#tool-argument-type-checking"></a></h3>
<p>Tool wrappers generated for the child process include runtime type validation when <code>args</code> have type annotations (e.g., <code>args = list(x = "numeric")</code>). Supported types: numeric, character, logical, integer, list, data.frame. Mismatches produce clear errors before the tool call is dispatched.</p>
</div>
<div class="section level3">
<h3 id="verbose-logging">Verbose Logging<a class="anchor" aria-label="anchor" href="#verbose-logging"></a></h3>
<p><code>SecureSession$new(verbose = TRUE)</code> logs lifecycle events via <code><a href="https://rdrr.io/r/base/message.html" class="external-link">message()</a></code>: session start/close, tool calls with args and timing, execution completion, errors, and timeouts. Users can suppress with <code><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="concurrent-execution-guard">Concurrent Execution Guard<a class="anchor" aria-label="anchor" href="#concurrent-execution-guard"></a></h3>
<p>A private <code>executing</code> flag prevents parallel <code>$execute()</code> calls on the same session. The flag is reset via <code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> to guarantee cleanup even on errors.</p>
</div>
<div class="section level3">
<h3 id="code-pre-validation">Code Pre-Validation<a class="anchor" aria-label="anchor" href="#code-pre-validation"></a></h3>
<p><code>$execute(code, validate = TRUE)</code> parses code with <code>parse(text=)</code> before sending to the child, catching syntax errors immediately. Also warns on dangerous patterns (<code><a href="https://rdrr.io/r/base/system.html" class="external-link">system()</a></code>, <code><a href="https://rdrr.io/r/base/Internal.html" class="external-link">.Internal()</a></code>, etc.) — advisory only, the sandbox handles actual restriction.</p>
</div>
<div class="section level3">
<h3 id="streaming-output">Streaming Output<a class="anchor" aria-label="anchor" href="#streaming-output"></a></h3>
<p><code>$execute(code, output_handler = function(line) ...)</code> pipes child stdout/stderr and drains output each event loop iteration. Output is also available as <code>attr(result, "output")</code> on the return value.</p>
</div>
<div class="section level3">
<h3 id="file-based-audit-log">File-Based Audit Log<a class="anchor" aria-label="anchor" href="#file-based-audit-log"></a></h3>
<p><code>SecureSession$new(audit_log = "/path/to/log.jsonl")</code> writes structured JSONL entries for session lifecycle, tool calls, and execution events. Each session gets a unique <code>session_id</code> for correlation.</p>
</div>
<div class="section level3">
<h3 id="session-pooling">Session Pooling<a class="anchor" aria-label="anchor" href="#session-pooling"></a></h3>
<p><code>SecureSessionPool$new(size = 4)</code> pre-warms N sessions. <code>$execute()</code> acquires an idle session, runs code, and returns it to the pool. Dead sessions are auto-restarted on acquire.</p>
</div>
<div class="section level3">
<h3 id="ellmer-integration">ellmer Integration<a class="anchor" aria-label="anchor" href="#ellmer-integration"></a></h3>
<p><code><a href="reference/securer_as_ellmer_tool.html">securer_as_ellmer_tool()</a></code> wraps a SecureSession as an <code><a href="https://ellmer.tidyverse.org/reference/tool.html" class="external-link">ellmer::tool()</a></code> definition. Errors are returned as <code>ContentToolResult(error=...)</code> so they don’t crash the LLM chat. ellmer is a soft dependency (Suggests).</p>
</div>
</div>
<div class="section level2">
<h2 id="development-commands">Development Commands<a class="anchor" aria-label="anchor" href="#development-commands"></a></h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># Run tests</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::test('.')"</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co"># Run R CMD check</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::check('.')"</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co"># Regenerate docs (after roxygen changes)</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::document('.')"</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co"># Load for interactive testing</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"devtools::load_all('.')"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="test-structure">Test Structure<a class="anchor" aria-label="anchor" href="#test-structure"></a></h2>
<ul><li>
<code>test-secure-session.R</code> — Session lifecycle, timeouts, concurrent execution guard</li>
<li>
<code>test-ipc.R</code> — Tool call pause/resume via <code>.securer_call_tool()</code> directly</li>
<li>
<code>test-tool-registry.R</code> — securer_tool(), validation, wrappers, type checking, end-to-end</li>
<li>
<code>test-sandbox.R</code> — Sandbox restrictions (macOS/Linux/Windows), rlimits</li>
<li>
<code>test-execute.R</code> — <code><a href="reference/execute_r.html">execute_r()</a></code> convenience API</li>
<li>
<code>test-logging.R</code> — Verbose logging output verification</li>
<li>
<code>test-validate.R</code> — Code pre-validation (syntax errors, dangerous patterns)</li>
<li>
<code>test-audit-log.R</code> — JSONL audit log events and structure</li>
<li>
<code>test-session-pool.R</code> — Pool lifecycle, acquire/release, error recovery</li>
<li>
<code>test-ellmer.R</code> — ellmer tool definition, execution, error handling</li>
</ul></div>
<div class="section level2">
<h2 id="platform-notes">Platform Notes<a class="anchor" aria-label="anchor" href="#platform-notes"></a></h2>
<ul><li>
<strong>macOS</strong>: Full sandbox via Seatbelt. Requires <code>/usr/bin/sandbox-exec</code>.</li>
<li>
<strong>Linux</strong>: Full sandbox via bubblewrap (<code>bwrap</code>). Requires <code>bwrap</code> on PATH.</li>
<li>
<strong>Windows</strong>: Environment isolation only (clean HOME/TMPDIR, empty R_LIBS_USER). No filesystem/network restrictions.</li>
</ul><p>Sandbox tests use <code>skip_on_os()</code> and <code>skip_if_not()</code> to gate platform-specific tests.</p>
</div>
<div class="section level2">
<h2 id="known-limitations">Known Limitations<a class="anchor" aria-label="anchor" href="#known-limitations"></a></h2>
<ul><li>Windows sandbox provides environment isolation only — no filesystem or network restrictions without admin privileges</li>
<li>Single concurrent session per <code>SecureSession</code> instance — concurrent <code>$execute()</code> calls are detected and rejected with an error</li>
</ul></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ian Flores Siaca.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

